#!/usr/bin/env ruby

require 'trollop'
require 'bio'
require 'sci'
require 'yell'

include SCI

# Performance settings
RUBY_GC_HEAP_GROWTH_FACTOR=2
RUBY_GC_MALLOC_LIMIT=40000000
RUBY_GC_MALLOC_LIMIT_MAX=75000000


# Show the help message without arguments

ARGV[0] = "--help" if ARGV.length == 0

# We want clean error messages through the logger, no ugly backtraces
# because the user doesn't care about them, unless they specifically ask for
# them with --loglevel debug
module Kernel
  alias _raise raise

  def raise(*a)
    begin
      _raise(*a)
    rescue SCIError => e
      logger.error e.message
      logger.debug e.backtrace unless e.backtrace.nil?
      exit 1
    end
  end
end


opts = Trollop::options do
  version SCI::VERSION
  banner <<-EOS
  SCI v#{SCI::VERSION}
  by Matt Ralston <mrals@udel.edu>
  DESCRIPTION:
  Calculates a complexity metric for each base in the genome,
  an alternative to pileup format.
  The complexity metric is calculated for each base in the genome as the product of a read-length normalized average read overlap and a read-length normalized number of unique reads.

  Bug reports and feature requests at:
  http://github.com/MatthewRalston/sci
  USAGE:
  sci --reference REFERENCE_FASTA --bam SORTED_BAM <options>

  EXAMPLES:
  # compute sci for a set of reeads
  sci --reference genome.fa --bam aligned_reads.bam


  OPTIONS:
  EOS
  opt :reference, "Reference genome in fasta format.",
      :type => String,
      :required => true
  opt :bam, "Sorted bam file.",
      :type => String,
      :required => true
  opt :strand, "Strand specific option. One of [FR, RF, F].",
      :type => String
  opt :threads, "Number of threads to use",
      :default => 1,
      :type => Integer
  opt :outfile, "Prefix filename to use for CSV output",
      :default => "sci.csv"
  opt :loglevel, "The amount of information to print. " +
                 "One of [error, info, warn, debug]",
      :default => 'info'
end

####################
# Handle commands
####################
# Logging
unless %w[error info warn debug].include? opts.loglevel
  raise SCIError.new "Loglevel #{opts.loglevel} is not valid. " +
  "It must be one of: error, info, warn, debug."
end

logger.level = Yell::Level.new opts.loglevel.to_sym

# Strand specific option
if opts.strand
  unless %w[FR RF F].include? opts.strand
    raise SCIError.new "Strand specific option #{opts.strand} is invalid." +
      " It must be one of: [FR, RF, F]"
  end
end

# Bam and fasta files exist
if opts.bam && opts.reference
  if !File.exist?(opts.bam)
    raise SCIIOError.new "BAM file #{opts.bam} does not exist."
  elsif !File.exist?(opts.reference)
    raise SCIIOError.new "Fasta file #{opts.reference} does not exist."
  end
else
  raise SCIIOError.new "A sorted BAM file and a fasta file are required."
end

####################
# Run calculation
####################
logger.info "Opening BAM and reference files for calculation."
calculator = Calculator.new(opts.bam,opts.reference,strand: opts.strand,threads: opts.threads)

if opts.loglevel == "debug"
  calculator.run(runtime: true)
else
  calculator.run
end


outfile = opts.outfile
logger.info "Writing sequencing complexity index to #{outfile}"
calculator.export(outfile)

logger.info "Calculation complete."
